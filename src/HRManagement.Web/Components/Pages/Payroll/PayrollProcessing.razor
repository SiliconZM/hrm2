@page "/payroll/payroll-runs/{PayrollId:long}/process"
@using HRManagement.Models.DTOs
@using HRManagement.Services.Interfaces
@inject IPayrollService PayrollService
@inject IEmployeeService EmployeeService
@inject NavigationManager NavigationManager

<PageTitle>Process Payroll</PageTitle>

<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>Process Payroll</h2>
            @if (payroll != null)
            {
                <p class="text-muted">@payroll.PayrollName (@payroll.StartDate.ToString("yyyy-MM-dd") to @payroll.EndDate.ToString("yyyy-MM-dd"))</p>
            }
        </div>
        <div class="col-md-4 text-end">
            <a href="/payroll/payroll-runs" class="btn btn-secondary">Back to Payroll Runs</a>
        </div>
    </div>

    @if (error != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Error:</strong> @error
            <button type="button" class="btn-close" @onclick="@(() => error = null)"></button>
        </div>
    }

    @if (successMessage != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>Success:</strong> @successMessage
            <button type="button" class="btn-close" @onclick="@(() => successMessage = null)"></button>
        </div>
    }

    @if (loading)
    {
        <div class="alert alert-info">Loading payroll details...</div>
    }
    else if (payroll == null)
    {
        <div class="alert alert-warning">Payroll not found.</div>
    }
    else
    {
        <!-- Payroll Summary -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title text-muted">Status</h6>
                        <h4>
                            <span class="badge" style="background-color: @GetStatusColor(payroll.Status); font-size: 1rem;">
                                @payroll.Status
                            </span>
                        </h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title text-muted">Employees</h6>
                        <h4>@payroll.EmployeeCount</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title text-muted">Gross Salary</h6>
                        <h4>@payroll.TotalGrossSalary.ToString("C")</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title text-muted">Net Salary</h6>
                        <h4>@payroll.TotalNetSalary.ToString("C")</h4>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bulk Add Employees Section -->
        @if (payroll.Status == "Draft")
        {
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Add Employees to Payroll</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Select Employees *</label>
                            <select class="form-select" @bind="selectedEmployeeIds" multiple size="5">
                                @foreach (var employee in availableEmployees)
                                {
                                    <option value="@employee.EmployeeId">
                                        @employee.FirstName @employee.LastName (@employee.EmployeeCode)
                                    </option>
                                }
                            </select>
                            <small class="text-muted">Hold Ctrl (Cmd on Mac) to select multiple employees</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Working Days</label>
                            <input type="number" class="form-control" @bind="bulkWorkingDays" min="0" max="31" placeholder="e.g., 20" />
                            <small class="text-muted">Optional: Will be applied to all selected employees</small>
                        </div>
                    </div>
                    <button class="btn btn-primary" @onclick="BulkAddEmployees" disabled="@(adding || selectedEmployeeIds?.Count == 0)">
                        @if (adding)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        Add Selected Employees
                    </button>
                </div>
            </div>
        }

        <!-- Payroll Details List -->
        <div class="card">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Payroll Details</h5>
                <span class="badge bg-info">@(payrollDetails?.Count ?? 0) Employees</span>
            </div>
            <div class="card-body">
                @if (payrollDetails == null || payrollDetails.Count == 0)
                {
                    <div class="alert alert-info">No employees in this payroll run. Add employees to get started.</div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Employee</th>
                                    <th>Gross Salary</th>
                                    <th>Deductions</th>
                                    <th>Tax</th>
                                    <th>Net Salary</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var detail in payrollDetails)
                                {
                                    <tr>
                                        <td><strong>@detail.EmployeeName</strong></td>
                                        <td>@detail.GrossSalary.ToString("C")</td>
                                        <td>@detail.TotalDeductions.ToString("C")</td>
                                        <td>@detail.TotalTax.ToString("C")</td>
                                        <td><strong>@detail.NetSalary.ToString("C")</strong></td>
                                        <td>
                                            <span class="badge" style="background-color: @GetDetailStatusColor(detail.Status)">
                                                @detail.Status
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-info me-1"
                                                    @onclick="() => EditDetail(detail.PayrollDetailId)"
                                                    disabled="@(detail.Status == "Approved")">
                                                <i class="bi bi-pencil"></i> Edit
                                            </button>
                                            @if (detail.Status != "Approved")
                                            {
                                                <button class="btn btn-sm btn-success"
                                                        @onclick="() => ApproveDetail(detail.PayrollDetailId)"
                                                        disabled="@(approvingId == detail.PayrollDetailId)">
                                                    @if (approvingId == detail.PayrollDetailId)
                                                    {
                                                        <span class="spinner-border spinner-border-sm me-1"></span>
                                                    }
                                                    <i class="bi bi-check-circle"></i> Approve
                                                </button>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>

        <!-- Processing Section -->
        @if (payrollDetails != null && payrollDetails.Count > 0)
        {
            <div class="mt-4">
                @if (payroll.Status == "Draft")
                {
                    <button class="btn btn-success btn-lg me-2" @onclick="ProcessPayroll" disabled="@processing">
                        @if (processing)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        Process Payroll
                    </button>
                    <small class="text-muted d-block mt-2">Processing will calculate final payroll totals and move it to Processed status.</small>
                }
                else if (payroll.Status == "Processed")
                {
                    <div class="alert alert-info">
                        This payroll has been processed. You can now review salary slips or mark as paid.
                    </div>
                    <a href="/payroll/salary-slips?payrollId=@PayrollId" class="btn btn-primary">
                        View Salary Slips
                    </a>
                }
            </div>
        }
    }
</div>

<!-- Edit Detail Modal -->
@if (editingDetailId > 0 && editingDetail != null)
{
    <div class="modal fade show d-block" role="dialog" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Payroll Detail</h5>
                    <button type="button" class="btn-close" @onclick="CloseEditModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Working Days</label>
                        <input type="number" class="form-control" @bind="editingDetail.WorkingDays" min="0" max="31" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Days Worked</label>
                        <input type="number" class="form-control" @bind="editingDetail.DaysWorked" min="0" max="31" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Leave Days</label>
                        <input type="number" class="form-control" @bind="editingDetail.LeavesDays" min="0" max="31" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Remarks</label>
                        <textarea class="form-control" @bind="editingDetail.Remarks" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseEditModal">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveEditDetail" disabled="@(updatingDetail)">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public long PayrollId { get; set; }

    private PayrollDto? payroll;
    private List<PayrollDetailDto>? payrollDetails;
    private List<EmployeeDto>? availableEmployees;
    private List<long>? selectedEmployeeIds;
    private int? bulkWorkingDays;

    private bool loading = true;
    private bool adding = false;
    private bool processing = false;
    private long approvingId = 0;
    private bool updatingDetail = false;
    private string? error;
    private string? successMessage;
    private const long OrganizationId = 1;

    // Edit modal
    private long editingDetailId = 0;
    private PayrollDetailDto? editingDetail;

    protected override async Task OnInitializedAsync()
    {
        await LoadPayrollData();
        await LoadAvailableEmployees();
    }

    private async Task LoadPayrollData()
    {
        try
        {
            loading = true;
            error = null;
            payroll = await PayrollService.GetPayrollByIdAsync(PayrollId);
            payrollDetails = await PayrollService.GetPayrollDetailsAsync(PayrollId);
        }
        catch (Exception ex)
        {
            error = $"Failed to load payroll data: {ex.Message}";
        }
        finally
        {
            loading = false;
        }
    }

    private async Task LoadAvailableEmployees()
    {
        try
        {
            var result = await EmployeeService.GetAllAsync(OrganizationId, 1, 1000);
            availableEmployees = result.Items.ToList();

            // Filter out employees already in the payroll
            if (availableEmployees != null && payrollDetails != null)
            {
                var addedEmployeeIds = payrollDetails.Select(p => p.EmployeeId).ToList();
                availableEmployees = availableEmployees
                    .Where(e => !addedEmployeeIds.Contains(e.EmployeeId))
                    .ToList();
            }
        }
        catch (Exception ex)
        {
            error = $"Failed to load employees: {ex.Message}";
        }
    }

    private async Task BulkAddEmployees()
    {
        if (selectedEmployeeIds == null || selectedEmployeeIds.Count == 0)
        {
            error = "Please select at least one employee";
            return;
        }

        try
        {
            adding = true;
            error = null;

            foreach (var employeeId in selectedEmployeeIds)
            {
                var request = new CreatePayrollDetailRequest
                {
                    PayrollId = PayrollId,
                    EmployeeId = employeeId,
                    WorkingDays = bulkWorkingDays,
                    DaysWorked = bulkWorkingDays,
                    Remarks = "Added via bulk import"
                };
                await PayrollService.CreatePayrollDetailAsync(request);
            }

            successMessage = $"Successfully added {selectedEmployeeIds.Count} employee(s) to the payroll";
            selectedEmployeeIds.Clear();
            bulkWorkingDays = null;
            await LoadPayrollData();
            await LoadAvailableEmployees();
        }
        catch (Exception ex)
        {
            error = $"Failed to add employees: {ex.Message}";
        }
        finally
        {
            adding = false;
        }
    }

    private void EditDetail(long payrollDetailId)
    {
        if (payrollDetails != null)
        {
            editingDetail = payrollDetails.FirstOrDefault(d => d.PayrollDetailId == payrollDetailId);
            if (editingDetail != null)
            {
                editingDetailId = payrollDetailId;
            }
        }
    }

    private void CloseEditModal()
    {
        editingDetailId = 0;
        editingDetail = null;
    }

    private async Task SaveEditDetail()
    {
        if (editingDetail == null)
            return;

        try
        {
            updatingDetail = true;
            error = null;
            await PayrollService.UpdatePayrollDetailAsync(editingDetailId, editingDetail);
            successMessage = "Payroll detail updated successfully";
            CloseEditModal();
            await LoadPayrollData();
        }
        catch (Exception ex)
        {
            error = $"Failed to update payroll detail: {ex.Message}";
        }
        finally
        {
            updatingDetail = false;
        }
    }

    private async Task ApproveDetail(long payrollDetailId)
    {
        try
        {
            approvingId = payrollDetailId;
            error = null;
            await PayrollService.ApprovePayrollDetailAsync(payrollDetailId);
            successMessage = "Payroll detail approved successfully";
            await LoadPayrollData();
        }
        catch (Exception ex)
        {
            error = $"Failed to approve payroll detail: {ex.Message}";
        }
        finally
        {
            approvingId = 0;
        }
    }

    private async Task ProcessPayroll()
    {
        if (payroll == null)
            return;

        try
        {
            processing = true;
            error = null;
            await PayrollService.ProcessPayrollAsync(PayrollId);
            successMessage = "Payroll processed successfully";
            await LoadPayrollData();
        }
        catch (Exception ex)
        {
            error = $"Failed to process payroll: {ex.Message}";
        }
        finally
        {
            processing = false;
        }
    }

    private string GetStatusColor(string status)
    {
        return status switch
        {
            "Draft" => "#6c757d",
            "Processed" => "#0dcaf0",
            "Paid" => "#28a745",
            "Cancelled" => "#dc3545",
            _ => "#17a2b8"
        };
    }

    private string GetDetailStatusColor(string status)
    {
        return status switch
        {
            "Pending" => "#6c757d",
            "Approved" => "#28a745",
            "Processed" => "#0dcaf0",
            "Rejected" => "#dc3545",
            _ => "#17a2b8"
        };
    }
}
